%@article{jones1986perception,
 % title={Perception of force and weight: theory and research.},
  %author={Jones, Lynette A},
  %journal={Psychological bulletin},
  %volume={100},
  %number={1},
  %pages={29},
  %year={1986},
  %publisher={American Psychological Association}
%}

\chapter{Force Estimation}
In order to have a representation of the reaction force on the EndoWrist, estimations is needed.
Because of the reasons mentioned in chapter \ref{introduction}, the force cannot be measured using sensors and thus we have to rely on mathematical models as functions of torque measurements.

The main challenge faced in making a model lies in the fact that the pulley system on the EndoWrist is nonlinear, and thus its full dynamics cannot be modeled in a straightforward manner. 
In other words, to have an accurate representation of Cartesian force a higher order model is required.

Another method of tackling this problem is to create multiple mathematical models pertaining to forces output by actions performed with the EndoWrist.
In this manner, the feedback vector is transformed from Cartesian space to a task space in which the chosen actions form a basis.
Each element of the new feedback vector corresponds to an actuated axis of the Geomagic Touch.
For the purpose of this system, we choose to feedback the grip force on the clamps, the force generated by the roll actuator and force exerted by the clamps pitch movement.

\section{System Identification}
System identification is performed by fitting input and output data of the system to a known (grey-box) or unknown (black-box) mathematical model, generated either using theoretcal knowledge or data-fitting algorithms. 
This is done by changing the parameters of the model in a way that increases some measure of the quality of the model.

For our project, we require our model to output a measure of the force exerted by the EndoWrist.
Ideally a mathematical model derived from classical mechanics would be used to describe the dynamics involved in EndoWrist movement.
However, deriving this model precisely enough for grey-box identification has been proven difficult and time consuming due to the nonlinear nature of the dynamics (ref).

The exception is the roll force, which is determined by the roll actuator and directly rotates the entire tool, making it independent to the rest of the system.
This means we can make the assumption of linearity for the relation between the roll actuator effort and force.  
By simple measurement with the setup in figures \ref{fig:entire_force_testsetup} and \ref{fig:endeffector_force} we determine to roll model as a simple
linear approximation.

\begin{align}
F_{roll} = m e_{roll} + b
\end{align}

The same assumption of linearity cannot be assumed for the rest of the EndoWrists forces.
The nonlinearity of EndoWrist dynamics emerges from friction forces between the pulley strings controlling the end-effector, which causes multiple pulleys to move in cases where we only want to move one. 
Also, the strings themselves are elastic, which adds another dimension of nonlinearity.

For these reasons it was decided to test out different black box identification algorithms which only provide a general model structure where parameters don't have any physical meaning. Parameters are then identified using different variations of these algorithms and checked for accuraccy.

The system identification proces used in this project can be described in three steps:
\begin{enumerate}
\item Picking a model structure
\item Identifying parameters
\item Model validation
\end{enumerate}

%For this reason we have chosen to fit the dynamics of the yaw and pitch forces linear state-space models, while the roll force can be described using an linear approximation.
\subsection{Model structure}
The first choice regarding model structure pertains to linearity.
Since our system is nonlinear , a straightforward approach would involve choosing a nonlinear model structure for identification.
On the other hand, stability analysis of nonlinear models is difficult and due to the nature of the system only general trends in force need to be represented.
For this reason it was decided to identify a linear state-space model which is then used as a part of Hammerstein-Weiner nonlinear model.

A state-space model separates the dynamics of a system into a set of first-order differential equations.
Additionally, if the dynamical system is linear, time-invariant, and finite-dimensional, then the differential and algebraic equations may be written in matrix form. The general structure of such models is presented in equations \ref{eq:ssc}and \ref{eq:ssd} for the continous and discrete variants, respectively.

\begin{align}\label{eq:ssc}
\dot{\mathbf{x}} = \mathbf{A}\mathbf{x} + \mathbf{B}\mathbf{u} \\
\mathbf{y} = \mathbf{C}\mathbf{x} + \mathbf{D}\mathbf{u}
\end{align}
\vspace{-0.5cm}
\begin{align}\label{eq:ssd}
\mathbf{x}(k+1) = \mathbf{A}\mathbf{x}(k) + \mathbf{B}\mathbf{u}(k)\\
\mathbf{y}(k+1) = \mathbf{C}\mathbf{x}(k) + \mathbf{D}\mathbf{u}(k)
\end{align}

This representation of a system is especially useful in MIMO systems as it maintains the same form for any number of inputs and outputs, as opposed to transfer functions.

An identified state-space model can then be used as the linear part of an Hammerstein-Weiner model.
Hammerstein-Wiener models are useful when the output of the system depends nonlinearly on it's inputs, in this case it is possible to decompose the system into linear and nonlinear parts, as seen in \figref{weiner}. 
The nonlinearity estimators at the inputs and outputs of the system can be modeled by a variety of nonlinear systems, such as deadzones, saturations or even neural networks.

\begin{figure} 
\centering
\resizebox{0.9\textwidth}{!}{
\begin{tikzpicture}
\draw  (-3.5,3) rectangle (0,1) node[pos=.5] {Linear Block};
\draw  (-9,3) rectangle (-5.5,1) node[pos=.5] {Input Nonlinearity};
\draw  (2,3) rectangle (5.5,1) node[pos=.5] {Output Nonlinearity};
\draw [->] (-5.5,2) -- (-3.5,2) node [pos=0.5,above] {w(t)};
\draw [->] (-11,2) -- (-9,2) node [pos=0.5,above] {u(t)};
\draw [->] (0,2) -- (2,2) node [pos=0.5,above] {x(t)};
\draw [->] (5.45,2) -- (7.45,2) node [pos=0.5,above] {y(t)};
\end{tikzpicture}
}
\caption{Block diagram of a Hammerstein-Weiner model\ref{fig:weiner}}
\label{weiner}
\end{figure}

A deadzone nonlinearity on the input allows us to represent the effects of friction on the force and position, and is used in this model.
Different output nonlinearities are also utilized and compared.

\section{Parameter identification}
Once a general model structure has been chosen, parameter identification algorithms can be utilized.

For parameter identification to be performed on the Hammerstein-Weiner model, a linear model needs to be defined.
This means that it is first neccessary to identify the linear state-space model of the system.
Linear state space model fitting can be done using various methods , but for this purpose we have chosen the subspace identification algorithm.

Subspace identification is an algorithm that combines concepts from system theory, linear algebra and statistics in order to provide a state-space model of the system, which makes it useful for MIMO system identification (ref). 
The most important achievement subspace identification is based on is that Kalman filter states can be obtained from input-output data using linear algebra.
Although the algorithm itself is complex, it is implemented in the System Identification Toolbox as a part of MATLAB.

One advantage of subspace identification algorithms is the ability to estimate how much of the data dynamics a state-space model of a certain order can represent. 
As seen on figure (), the diminishing returns of increasing the state-space order are visible for different subspace identification algorithms.

%figure of subspace singular value analysis

\subsection{Identification data}
The outputs of the proposed models in both yaw and pitch cases are the position and force, while the inputs consist of velocity and current.
The data acquisition process is described in chapter () and will not be covered in this chapter.

However, the data contains various irregularities caused by the imperfect measuring process as well as the hardware.
For this reason parts of the data needed to be removed before identification, which required interpretation of restults.
Also, linear model identification showed the best results when done on data in which the strongly nonlinear effects of friction were "cropped".

%figure showing shitty data

Noise is also present and can be removed from the identification data using a low pass filter.
Since most of the dynamics are captured in the frequency band of 0 to 20 rad-1 , this frequency range was chosen for identification.
Also, it is useful to remove the offsets (means) on output data.
A sample of original and modified data can be seen on \figref{figlowpass}.
%example of data
%\input{rapport/pictures/lowpass}
\begin{figure}[H]
\centering
\includegraphics[width=1\linewidth]{lowpass.eps}
\caption{'Somthing cool'}
\label{figlowpass}
\end{figure}

\subsection{Linear model identification}

The System Identification Toolbox provides 3 different subspace identification algorithms which often provide different results depending on the chosen system order. 
For this reason all 3 algorithms are attempted in the identification process, and the best one is chosen depending on the average fit.
The algorithm which provides the best result varies heavily on the data set and the chosen order of the model.

%example of model fits to data
\begin{figure}[H]
\hspace{-2em}\includegraphics[width=1.15\linewidth]{sscomparison1}
\caption{'Somthing cool'}
\label{fig:1LMI}
\end{figure}



\begin{figure}[H]
\hspace{-2.5em}\includegraphics[width=1.15\linewidth]{sscomparison2}
\caption{'Somthing cool'}
\label{fig:2LMI}
\end{figure}


%\input{rapport/pictures/sscomparison1}
%\input{rapport/pictures/sscomparison2}

The parameter identification for the models was done in a manner that prioritizes force estimation over position, as position measurements are available.
Also, position estimation required a different dataset.

% here be resulting model

\subsection{Hammerstein-Weiner model identification}

Once the linear model is identified we can estimate the nonlinearities with the Hammerstein-Weiner model.
